# Infrastructure Documentation

This directory contains Terraform configurations for deploying the Askly chatbot infrastructure on AWS.

## AWS Resources

- **S3 Bucket**: Static website hosting for the React frontend
- **CloudFront**: CDN for global content delivery
- **Lambda**: Serverless API hosting for .NET backend
- **AWS Aurora DSQL**: PostgreSQL database
- **ACM**: SSL/TLS certificates for custom domains
- **Systems Manager**: Parameter store for secrets management

## Domain Configuration

### DNS Setup (Example: Porkbun)

#### ACM Certificate Validation

- Type: CNAME
- Host: CNAME name (e.g. xxxxx.microapps.info) without the dots
- Value: CNAME value (e.g. xxxxxx.acm-validations.aws) without the dots (check us-east-1 region)
- TTL: default is fine

#### CloudFront Distribution

- Type: CNAME
- Host: (the subdomain label only, e.g. dev)
- Value: the CloudFront distribution domain (dxxxxxxxxxxxx.cloudfront.net)
- TTL: default is fine

---

## Custom Domain Toggle (`enable_custom_domain`)

The Terraform variable `enable_custom_domain` (see [variables.tf](variables.tf)) controls whether the CloudFront distribution is configured to use your custom domain (e.g. `dev.microapps.info`) with an ACM certificate, or falls back to the default autogenerated `*.cloudfront.net` domain.

### Behavior

- When `enable_custom_domain = true`:

  - Terraform expects a valid ACM certificate in the same AWS account & (for CloudFront) in the `us-east-1` region that covers the value of `domain_name` (wildcard or specific).
  - Alternate domain names (CNAMEs) are added to the CloudFront distribution.
  - The ACM certificate ARN is associated with the distribution.
  - You must create / have the required DNS CNAME validation records (see sections above) and (after validation) a DNS record pointing your subdomain to the CloudFront distribution domain.

- When `enable_custom_domain = false`:
  - No alternate domain names are set on CloudFront.
  - No ACM certificate is attached.
  - You access the site using the default CloudFront domain that Terraform outputs (e.g. `dxxxxxxxxxxxx.cloudfront.net`).
  - DNS changes for the custom domain are NOT required.

### Typical Workflow

1. First apply with:
   - `enable_custom_domain = false`
   - This provisions S3, CloudFront, etc. quickly so you can test using the default domain.
2. Add the DNS validation CNAMEs at your registrar (see steps above).
3. Wait until the ACM certificate status becomes "Issued".
4. Flip `enable_custom_domain` to `true` (and ensure `domain_name` matches the certificate coverage).
5. `terraform apply` again to attach the cert and add the alternate domain names.
6. Create / verify the DNS CNAME (e.g. `dev.microapps.info -> dxxxxxxxxxxxx.cloudfront.net`).
7. Test HTTPS on the custom domain.
